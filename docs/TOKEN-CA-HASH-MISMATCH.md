# Token CA Hash ä¸åŒ¹é…é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

åœ¨éƒ¨ç½² K3S/RKE2 é›†ç¾¤æ—¶ï¼Œéåˆå§‹èŠ‚ç‚¹å¯åŠ¨å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼š

```
failed to validate token: token CA hash does not match the Cluster CA certificate hash:
96dddafdc2c74c7332786246660ddcdb9c89d5997d6f58759122551ef65eaa76 !=
fc3284e362699278b5e9675b1a9c487c04e96cb35df7963c5f521f508244c4f5
```

### ç—‡çŠ¶

- âœ… åˆå§‹èŠ‚ç‚¹ï¼ˆcluster_init=trueï¼‰è¿è¡Œæ­£å¸¸
- âŒ å…¶ä»– Server èŠ‚ç‚¹å¯åŠ¨å¤±è´¥å¹¶ä¸æ–­é‡å¯
- âŒ Agent èŠ‚ç‚¹å¯åŠ¨å¤±è´¥
- é”™è¯¯æ—¥å¿—æ˜¾ç¤º token CA hash ä¸åŒ¹é…

### å…¸å‹åœºæ™¯

1. ç¬¬ä¸€æ¬¡éƒ¨ç½²é›†ç¾¤ï¼Œç”Ÿæˆ Token Aï¼Œä¿å­˜åˆ° `/tmp/k3s-token.txt`
2. åæ¥å¸è½½å¹¶é‡æ–°éƒ¨ç½²é›†ç¾¤ï¼Œç”Ÿæˆæ–° Token B
3. ä½†æœ¬åœ°æ–‡ä»¶ `/tmp/k3s-token.txt` ä»ç„¶æ˜¯æ—§ Token A
4. éåˆå§‹èŠ‚ç‚¹è¯»å–æœ¬åœ°æ—§ Token Aï¼Œå°è¯•åŠ å…¥ä½¿ç”¨ Token B çš„é›†ç¾¤
5. CA hash ä¸åŒ¹é…ï¼Œå¯åŠ¨å¤±è´¥

## é—®é¢˜æ ¹å› 

### æ—§çš„ Token è·å–é€»è¾‘ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰

**ä¼˜å…ˆçº§é¡ºåºï¼š**
1. âœ… ä»é…ç½®æ–‡ä»¶è¯»å–ï¼ˆå¦‚æœå·²é…ç½®ï¼‰
2. âš ï¸ ä»æœ¬åœ°æ–‡ä»¶ `/tmp/{{ cluster_type }}-token.txt` è¯»å–
3. âœ… ä»åˆå§‹ Server èŠ‚ç‚¹å®æ—¶è·å–

**é—®é¢˜ï¼š**
- æœ¬åœ°æ–‡ä»¶å¯èƒ½åŒ…å«æ—§ tokenï¼ˆæ¥è‡ªä¹‹å‰çš„éƒ¨ç½²ï¼‰
- ä¼˜å…ˆä»æœ¬åœ°æ–‡ä»¶è¯»å–ï¼Œå¯¼è‡´ä½¿ç”¨è¿‡æœŸçš„ token
- è¿‡æœŸ token çš„ CA hash ä¸å½“å‰é›†ç¾¤çš„ CA è¯ä¹¦ä¸åŒ¹é…

### Token ç»“æ„

K3S/RKE2 çš„ token æ ¼å¼ï¼š
```
K10<CA_HASH>::server:<RANDOM_TOKEN>
```

ä¾‹å¦‚ï¼š
```
K10fc3284e362699278b5e9675b1a9c487c04e96cb35df7963c5f521f508244c4f5::server:bb9328723471f74ab7d29231bd6edd95
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CA Hash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€ Random Token â”€â”€â”€â”€â”˜
```

å½“é›†ç¾¤é‡æ–°åˆå§‹åŒ–æ—¶ï¼š
- CA è¯ä¹¦ä¼šé‡æ–°ç”Ÿæˆ
- CA Hash ä¼šæ”¹å˜
- Token ä¼šæ”¹å˜
- ä½†æœ¬åœ°ç¼“å­˜æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°

## è§£å†³æ–¹æ¡ˆ

### ä¸´æ—¶ä¿®å¤ï¼ˆå½“å‰é›†ç¾¤ï¼‰

å¦‚æœå½“å‰é›†ç¾¤å·²ç»é‡åˆ°æ­¤é—®é¢˜ï¼š

**æ­¥éª¤ 1ï¼šè·å–æ­£ç¡®çš„ token**

```bash
# ä»æ­£åœ¨è¿è¡Œçš„åˆå§‹èŠ‚ç‚¹è·å–
ansible -i inventory/hosts.ini node1 -b -m shell -a "cat /var/lib/rancher/k3s/server/node-token"
```

**æ­¥éª¤ 2ï¼šåœæ­¢å¤±è´¥çš„èŠ‚ç‚¹å¹¶æ¸…ç†æ•°æ®**

```bash
# åœæ­¢æœåŠ¡å¹¶æ¸…ç†æ•°æ®ç›®å½•
ansible -i inventory/hosts.ini node2,node3,worker1 -b -m shell -a "systemctl stop k3s k3s-agent && rm -rf /var/lib/rancher/k3s/server"
```

**æ­¥éª¤ 3ï¼šæ›´æ–°é…ç½®æ–‡ä»¶**

```bash
# æ›¿æ¢ä¸ºæ­£ç¡®çš„ token
ansible -i inventory/hosts.ini node2,node3,worker1 -b -m shell -a "sed -i 's|^token:.*|token: <æ­£ç¡®çš„token>|' /etc/rancher/k3s/config.yaml"
```

**æ­¥éª¤ 4ï¼šé‡å¯æœåŠ¡**

```bash
ansible -i inventory/hosts.ini node2,node3,worker1 -b -m shell -a "systemctl restart k3s k3s-agent"
```

### æ°¸ä¹…ä¿®å¤ï¼ˆå·²å®æ–½ï¼‰

ä¿®æ”¹äº† Token è·å–é€»è¾‘çš„**ä¼˜å…ˆçº§é¡ºåº**ï¼š

**æ–°çš„ä¼˜å…ˆçº§ï¼ˆæ¨èï¼‰ï¼š**
1. âœ… ä»é…ç½®æ–‡ä»¶è¯»å–ï¼ˆå¦‚æœå·²é…ç½®ï¼‰
2. âœ… **ä»åˆå§‹ Server èŠ‚ç‚¹å®æ—¶è·å–ï¼ˆä¼˜å…ˆï¼‰**
3. âœ… ä»æœ¬åœ°æ–‡ä»¶è¯»å–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
4. âœ… è·å–æˆåŠŸåè‡ªåŠ¨æ›´æ–°æœ¬åœ°æ–‡ä»¶

#### ä¿®æ”¹çš„æ–‡ä»¶

1. **`roles/rancher_cluster/tasks/install_server.yml`**
   - ä¼˜å…ˆä»åˆå§‹èŠ‚ç‚¹å®æ—¶è·å– token
   - æœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
   - è·å–åæ›´æ–°æœ¬åœ°æ–‡ä»¶

2. **`roles/rancher_cluster/tasks/install_agent.yml`**
   - ä¼˜å…ˆä» Server èŠ‚ç‚¹å®æ—¶è·å– token
   - æœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
   - è·å–åæ›´æ–°æœ¬åœ°æ–‡ä»¶

#### æ ¸å¿ƒæ”¹è¿›

```yaml
# 1. ä¼˜å…ˆä» Server èŠ‚ç‚¹è·å–ï¼ˆå®æ—¶ã€å‡†ç¡®ï¼‰
- name: ä»åˆå§‹ Server èŠ‚ç‚¹è·å– Token (éåˆå§‹èŠ‚ç‚¹)
  slurp:
    src: "{{ token_file }}"
  delegate_to: "{{ groups['rke_servers'][0] }}"
  register: server_token_content
  when: cluster_token is not defined or cluster_token | length == 0
  ignore_errors: yes

# 2. æœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ç”¨ï¼ˆç¦»çº¿åœºæ™¯ï¼‰
- name: ä»æœ¬åœ°æ–‡ä»¶è¯»å– Token (å¤‡ç”¨æ–¹æ¡ˆ)
  set_fact:
    cluster_token: "{{ lookup('file', '/tmp/' + cluster_type + '-token.txt') | trim }}"
  when:
    - cluster_token is not defined or cluster_token | length == 0
    - local_token_file.stat.exists

# 3. è·å–æˆåŠŸåæ›´æ–°æœ¬åœ°ç¼“å­˜
- name: æ›´æ–°æœ¬åœ° Token æ–‡ä»¶
  copy:
    content: "{{ cluster_token }}"
    dest: "/tmp/{{ cluster_type }}-token.txt"
  delegate_to: localhost
  when:
    - cluster_token is defined
    - cluster_token | length > 0
```

### ä¼˜åŠ¿

| æ–¹é¢ | æ—§é€»è¾‘ | æ–°é€»è¾‘ |
|------|--------|--------|
| Token æ–°é²œåº¦ | âŒ å¯èƒ½ä½¿ç”¨è¿‡æœŸ token | âœ… æ€»æ˜¯è·å–æœ€æ–° token |
| éƒ¨ç½²å¯é æ€§ | âŒ é‡æ–°éƒ¨ç½²æ˜“å¤±è´¥ | âœ… é‡æ–°éƒ¨ç½²å§‹ç»ˆæˆåŠŸ |
| ç¦»çº¿æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä»ç„¶æ”¯æŒï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰ |
| ç¼“å­˜æ›´æ–° | âŒ ä¸ä¼šæ›´æ–° | âœ… è‡ªåŠ¨æ›´æ–° |
| è°ƒè¯•éš¾åº¦ | âŒ é”™è¯¯ä¸æ˜æ˜¾ | âœ… æ—¥å¿—æ¸…æ™° |

## éªŒè¯

### 1. æ£€æŸ¥é›†ç¾¤çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€
ansible -i inventory/hosts.ini node1 -b -m shell -a "export KUBECONFIG=/etc/rancher/k3s/k3s.yaml && kubectl get nodes -o wide"
```

æœŸæœ›è¾“å‡ºï¼šæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸º `Ready`

### 2. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# Server èŠ‚ç‚¹
ansible -i inventory/hosts.ini rke_servers -b -m shell -a "systemctl status k3s --no-pager | head -15"

# Agent èŠ‚ç‚¹
ansible -i inventory/hosts.ini rke_agents -b -m shell -a "systemctl status k3s-agent --no-pager | head -15"
```

æœŸæœ›è¾“å‡ºï¼šæ‰€æœ‰æœåŠ¡ `Active: active (running)`

### 3. éªŒè¯ Token ä¸€è‡´æ€§

```bash
# æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨çš„ token
ansible -i inventory/hosts.ini all -b -m shell -a "grep '^token:' /etc/rancher/k3s/config.yaml || echo 'No token in config'"
```

æœŸæœ›è¾“å‡ºï¼šæ‰€æœ‰èŠ‚ç‚¹çš„ token åº”è¯¥ç›¸åŒ

### 4. æ£€æŸ¥æœ¬åœ°ç¼“å­˜

```bash
# æŸ¥çœ‹æœ¬åœ° token æ–‡ä»¶
cat /tmp/k3s-token.txt

# åº”è¯¥ä¸åˆå§‹èŠ‚ç‚¹çš„ token ä¸€è‡´
```

## é¢„é˜²æªæ–½

### 1. å®Œå…¨å¸è½½åé‡æ–°éƒ¨ç½²

ç¡®ä¿å¸è½½å¹²å‡€ï¼Œé¿å…æ®‹ç•™æ•°æ®ï¼š

```bash
# å®Œå…¨å¸è½½
make uninstall

# éªŒè¯æ¸…ç†
make verify-uninstall

# æ¸…ç†æœ¬åœ°ç¼“å­˜
rm -f /tmp/k3s-token.txt /tmp/rke2-token.txt

# é‡æ–°éƒ¨ç½²
make install
```

### 2. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶

ä¸è¦åœ¨é…ç½®æ–‡ä»¶ä¸­ç¡¬ç¼–ç  tokenï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨è·å–ï¼š

```yaml
# inventory/group_vars/all.yml
server_url: "https://192.168.1.166:6443"
cluster_token: ""  # ç•™ç©ºï¼Œè‡ªåŠ¨è·å–
```

### 3. ç›‘æ§éƒ¨ç½²æ—¥å¿—

æ³¨æ„ token è·å–çŠ¶æ€çš„æ—¥å¿—ï¼š

```
âœ“ æˆåŠŸè·å– cluster_token (from init server node)
```

æˆ–

```
âœ“ æˆåŠŸè·å– cluster_token (from local file)
```

### 4. ç”Ÿäº§ç¯å¢ƒå»ºè®®

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼š

1. **ä½¿ç”¨å›ºå®š token**ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ˜ç¡®æŒ‡å®š
2. **ä½¿ç”¨ ansible-vault åŠ å¯†**ï¼š
   ```bash
   ansible-vault encrypt_string 'your-token' --name 'cluster_token'
   ```
3. **å®šæœŸè½®æ¢**ï¼šæŒ‰ç…§å®‰å…¨ç­–ç•¥å®šæœŸæ›´æ¢ token
4. **æ–‡æ¡£è®°å½•**ï¼šè®°å½• token çš„ç”Ÿæˆæ—¶é—´å’Œå˜æ›´å†å²

## ç›¸å…³æ–‡æ¡£

- [AUTO-TOKEN-GUIDE.md](AUTO-TOKEN-GUIDE.md) - Token è‡ªåŠ¨è·å–æŒ‡å—
- [SERVICE-NAMES.md](SERVICE-NAMES.md) - æœåŠ¡åç§°è¯´æ˜
- [SYSTEMD-CLEANUP.md](SYSTEMD-CLEANUP.md) - systemd æ¸…ç†æŒ‡å—

## æ•…éšœæ’æŸ¥æµç¨‹å›¾

```
éƒ¨ç½²å¤±è´¥
    â†“
æŸ¥çœ‹é”™è¯¯æ—¥å¿—
    â†“
æ˜¯å¦ä¸º "token CA hash does not match"?
    â”œâ”€ æ˜¯ â†’ ç»§ç»­
    â””â”€ å¦ â†’ æŸ¥çœ‹å…¶ä»–æ•…éšœæ’æŸ¥æ–‡æ¡£
    â†“
æ£€æŸ¥åˆå§‹èŠ‚ç‚¹çŠ¶æ€
    â”œâ”€ æœªè¿è¡Œ â†’ å…ˆéƒ¨ç½²åˆå§‹èŠ‚ç‚¹
    â””â”€ è¿è¡Œæ­£å¸¸ â†’ ç»§ç»­
    â†“
è·å–æ­£ç¡® token
    â†“
åœæ­¢å¤±è´¥èŠ‚ç‚¹æœåŠ¡
    â†“
æ¸…ç†æ•°æ®ç›®å½•
    â†“
æ›´æ–°é…ç½®æ–‡ä»¶ token
    â†“
é‡å¯æœåŠ¡
    â†“
éªŒè¯é›†ç¾¤çŠ¶æ€
    â”œâ”€ æˆåŠŸ â†’ å®Œæˆ
    â””â”€ å¤±è´¥ â†’ æŸ¥çœ‹æ–°çš„é”™è¯¯æ—¥å¿—
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿä¸åŒçš„ tokenï¼Ÿ

A: æ¯æ¬¡åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼ŒK3S/RKE2 ä¼šç”Ÿæˆæ–°çš„ CA è¯ä¹¦å’Œ tokenã€‚å¦‚æœï¼š
- å¸è½½åé‡æ–°éƒ¨ç½²
- åˆ é™¤æ•°æ®ç›®å½•åé‡å¯
- æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–é›†ç¾¤

éƒ½ä¼šå¯¼è‡´ token æ”¹å˜ã€‚

### Q2: æœ¬åœ° token æ–‡ä»¶çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

A: æœ¬åœ° token æ–‡ä»¶ï¼ˆ`/tmp/k3s-token.txt`ï¼‰ä½œä¸ºï¼š
1. **ç¼“å­˜**ï¼šé¿å…æ¯æ¬¡éƒ½ä» server èŠ‚ç‚¹è·å–
2. **å¤‡ä»½**ï¼šç¦»çº¿éƒ¨ç½²æˆ– server èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ä½¿ç”¨
3. **è°ƒè¯•**ï¼šæ–¹ä¾¿æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„ token

### Q3: å¦‚ä½•åˆ¤æ–­ token æ˜¯å¦è¿‡æœŸï¼Ÿ

A: Token æœ¬èº«ä¸ä¼šè¿‡æœŸï¼Œä½†å½“ï¼š
- é›†ç¾¤é‡æ–°åˆå§‹åŒ–
- CA è¯ä¹¦é‡æ–°ç”Ÿæˆ
- token çš„ CA hash å°±ä¼šä¸é›†ç¾¤ä¸åŒ¹é…

åˆ¤æ–­æ–¹æ³•ï¼šæ¯”è¾ƒ token ä¸­çš„ CA hash ä¸é›†ç¾¤ CA è¯ä¹¦çš„ hashã€‚

### Q4: èƒ½å¦æ‰‹åŠ¨æŒ‡å®š tokenï¼Ÿ

A: å¯ä»¥ã€‚åœ¨ `inventory/group_vars/all.yml` ä¸­ï¼š

```yaml
cluster_token: "K10your-ca-hash::server:your-random-token"
```

ä½†å»ºè®®è®©ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ã€‚

### Q5: ä¿®å¤åéœ€è¦é‡æ–°éƒ¨ç½²æ•´ä¸ªé›†ç¾¤å—ï¼Ÿ

A: ä¸éœ€è¦ã€‚åªéœ€ï¼š
1. ä¿æŒåˆå§‹èŠ‚ç‚¹è¿è¡Œ
2. åœæ­¢å¤±è´¥çš„èŠ‚ç‚¹
3. æ¸…ç†æ•°æ®ç›®å½•
4. æ›´æ–°é…ç½®æ–‡ä»¶
5. é‡å¯æœåŠ¡

## æ€»ç»“

âœ… **é—®é¢˜**ï¼šæœ¬åœ°ç¼“å­˜çš„æ—§ token å¯¼è‡´ CA hash ä¸åŒ¹é…  
âœ… **æ ¹å› **ï¼šToken è·å–ä¼˜å…ˆçº§ä¸å½“  
âœ… **ä¿®å¤**ï¼šä¼˜å…ˆä» server èŠ‚ç‚¹å®æ—¶è·å–ï¼Œæœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ç”¨  
âœ… **æ•ˆæœ**ï¼šç¡®ä¿æ€»æ˜¯ä½¿ç”¨æœ€æ–°ã€æ­£ç¡®çš„ token  
âœ… **å…¼å®¹**ï¼šä»ç„¶æ”¯æŒç¦»çº¿éƒ¨ç½²åœºæ™¯  

ä»¥åçš„éƒ¨ç½²å°†è‡ªåŠ¨é¿å…æ­¤é—®é¢˜ï¼ğŸ‰

