# make setup å‘½ä»¤å¢å¼ºè¯´æ˜ (V2)

## ğŸ“‹ æ¦‚è¿°

`make setup` å‘½ä»¤å·²å¢å¼ºï¼Œç°åœ¨æ”¯æŒä¸€é”®è‡ªåŠ¨é…ç½® K3S æˆ– RKE2 é›†ç¾¤ï¼Œå¤§å¹…ç®€åŒ–åˆå§‹åŒ–æµç¨‹ã€‚

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. ä¸€é”®é…ç½® K3S

```bash
make setup k3s
```

**è‡ªåŠ¨é…ç½®é¡¹**ï¼š
- `cluster_type`: k3s
- `server_url`: https://FIRST_NODE_IP:6443
- `china_region`: true (å¯ç”¨ä¸­å›½é•œåƒåŠ é€Ÿ)

### 2. ä¸€é”®é…ç½® RKE2

```bash
make setup rke2
```

**è‡ªåŠ¨é…ç½®é¡¹**ï¼š
- `cluster_type`: rke2
- `server_url`: https://FIRST_NODE_IP:9345
- `china_region`: true (å¯ç”¨ä¸­å›½é•œåƒåŠ é€Ÿ)

### 3. ä¿æŒåŸæœ‰åŠŸèƒ½

```bash
make setup
```

**åŠŸèƒ½**ï¼š
- åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿
- æ˜¾ç¤ºè¯¦ç»†çš„é…ç½®æŒ‡å—
- éœ€è¦æ‰‹åŠ¨ç¼–è¾‘æ‰€æœ‰å‚æ•°

---

## ğŸš€ ä½¿ç”¨å¯¹æ¯”

### æ”¹è¿›å‰ï¼ˆæ—§æ–¹å¼ï¼‰

```bash
# æ­¥éª¤ 1: åˆå§‹åŒ–é…ç½®
make setup

# æ­¥éª¤ 2: æ‰‹åŠ¨ç¼–è¾‘ hosts.ini
vim inventory/hosts.ini
# éœ€è¦ä¿®æ”¹ï¼š
# - ansible_host
# - ansible_user
# - ansible_ssh_private_key_file
# - cluster_type (rke2 æˆ– k3s)

# æ­¥éª¤ 3: æ‰‹åŠ¨ç¼–è¾‘ all.yml
vim inventory/group_vars/all.yml
# éœ€è¦ä¿®æ”¹ï¼š
# - cluster_type
# - china_region
# - server_url (ç«¯å£æ ¹æ®ç±»å‹ä¸åŒ)

# æ­¥éª¤ 4: å®‰è£…
make install
```

**é—®é¢˜**ï¼š
- âŒ éœ€è¦è®°ä½ç«¯å£å·ï¼ˆRKE2: 9345, K3S: 6443ï¼‰
- âŒ éœ€è¦åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­ä¿®æ”¹ cluster_type
- âŒ å®¹æ˜“é—æ¼é…ç½®é¡¹
- âŒ æ­¥éª¤ç¹ç

### æ”¹è¿›åï¼ˆæ–°æ–¹å¼ï¼‰

```bash
# æ­¥éª¤ 1: ä¸€é”®åˆå§‹åŒ–é…ç½®
make setup k3s        # æˆ– make setup rke2

# æ­¥éª¤ 2: åªéœ€ä¿®æ”¹ IP å’Œ SSH ä¿¡æ¯
vim inventory/hosts.ini
# åªéœ€ä¿®æ”¹ï¼š
# - ansible_host
# - ansible_user
# - ansible_ssh_private_key_file
# - å°† FIRST_NODE_IP æ›¿æ¢ä¸ºå®é™… IP

# æ­¥éª¤ 3: å®‰è£…
make install
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨è®¾ç½®é›†ç¾¤ç±»å‹
- âœ… è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ç«¯å£å·
- âœ… è‡ªåŠ¨å¯ç”¨ä¸­å›½é•œåƒåŠ é€Ÿ
- âœ… å‡å°‘é…ç½®æ­¥éª¤
- âœ… é™ä½å‡ºé”™æ¦‚ç‡

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ—§æ–¹å¼ `make setup` | æ–°æ–¹å¼ `make setup k3s/rke2` |
|------|-------------------|------------------------------|
| **åˆ›å»ºé…ç½®æ–‡ä»¶** | âœ… æ˜¯ | âœ… æ˜¯ |
| **è‡ªåŠ¨è®¾ç½®é›†ç¾¤ç±»å‹** | âŒ éœ€æ‰‹åŠ¨ | âœ… è‡ªåŠ¨ |
| **è‡ªåŠ¨è®¾ç½®ç«¯å£** | âŒ éœ€æ‰‹åŠ¨ | âœ… è‡ªåŠ¨ |
| **è‡ªåŠ¨å¯ç”¨ä¸­å›½é•œåƒ** | âŒ éœ€æ‰‹åŠ¨ | âœ… è‡ªåŠ¨ |
| **ä¿®æ”¹æ–‡ä»¶æ•°é‡** | 2 ä¸ª | 1 ä¸ª |
| **é…ç½®æ—¶é—´** | ~5 åˆ†é’Ÿ | ~2 åˆ†é’Ÿ |
| **å‡ºé”™æ¦‚ç‡** | ä¸­ | ä½ |

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å¿«é€Ÿæµ‹è¯•ç¯å¢ƒ

```bash
# æœ€å¿«é€Ÿåº¦æ­å»º K3S æµ‹è¯•é›†ç¾¤
make setup k3s
vim inventory/hosts.ini    # åªæ”¹ IP
make install
```

**ç”¨æ—¶**: ~5 åˆ†é’Ÿ

### åœºæ™¯ 2: ç”Ÿäº§çº§é›†ç¾¤

```bash
# æ­å»ºç”Ÿäº§çº§ RKE2 HA é›†ç¾¤
make setup rke2
vim inventory/hosts.ini    # é…ç½® 3 ä¸ª master èŠ‚ç‚¹
make install
```

**ç”¨æ—¶**: ~10 åˆ†é’Ÿ

### åœºæ™¯ 3: è‡ªå®šä¹‰éœ€æ±‚

```bash
# éœ€è¦è‡ªå®šä¹‰ç½‘ç»œã€å­˜å‚¨ç­‰é«˜çº§é…ç½®
make setup k3s             # å…ˆç”¨è‡ªåŠ¨é…ç½®
vim inventory/group_vars/all.yml  # å†è°ƒæ•´é«˜çº§å‚æ•°
make install
```

**ç”¨æ—¶**: ~15 åˆ†é’Ÿ

---

## ğŸ”§ æŠ€æœ¯å®ç°

### Makefile å¢å¼º

```makefile
setup: ## åˆå§‹åŒ–é…ç½®æ–‡ä»¶ (ç”¨æ³•: make setup [k3s|rke2])
	@CLUSTER_TYPE=""; \
	if [ "$(filter k3s,$(MAKECMDGOALS))" = "k3s" ]; then \
		CLUSTER_TYPE="k3s"; \
	elif [ "$(filter rke2,$(MAKECMDGOALS))" = "rke2" ]; then \
		CLUSTER_TYPE="rke2"; \
	fi; \
	# ... è‡ªåŠ¨é…ç½®é€»è¾‘ ...
```

**å…³é”®æŠ€æœ¯**ï¼š
1. `MAKECMDGOALS`: è·å–å‘½ä»¤è¡Œå‚æ•°
2. `filter` å‡½æ•°: æå–ç‰¹å®šå‚æ•°
3. `sed` å‘½ä»¤: æ‰¹é‡æ›¿æ¢é…ç½®
4. æ¡ä»¶åˆ¤æ–­: æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒç«¯å£

### å ä½ç¬¦ç›®æ ‡

```makefile
# å ä½ç¬¦ç›®æ ‡ (ç”¨äº setup å‘½ä»¤çš„å‚æ•°)
k3s:
	@:
rke2:
	@:
```

**ä½œç”¨**ï¼š
- è®© `k3s` å’Œ `rke2` ä½œä¸ºæœ‰æ•ˆçš„ Make ç›®æ ‡
- é¿å… "No rule to make target" é”™è¯¯
- `@:` æ˜¯ç©ºå‘½ä»¤ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ

---

## ğŸ“ é…ç½®æ–‡ä»¶å˜æ›´

### hosts.ini å˜æ›´

**K3S æ¨¡å¼**ï¼š
```ini
# è‡ªåŠ¨è®¾ç½®
cluster_type=k3s
```

**RKE2 æ¨¡å¼**ï¼š
```ini
# è‡ªåŠ¨è®¾ç½®
cluster_type=rke2
```

### all.yml å˜æ›´

**K3S æ¨¡å¼**ï¼š
```yaml
# è‡ªåŠ¨è®¾ç½®
cluster_type: "k3s"
china_region: true
server_url: "https://FIRST_NODE_IP:6443"
```

**RKE2 æ¨¡å¼**ï¼š
```yaml
# è‡ªåŠ¨è®¾ç½®
cluster_type: "rke2"
china_region: true
server_url: "https://FIRST_NODE_IP:9345"
```

---

## âœ… æµ‹è¯•éªŒè¯

### K3S é…ç½®éªŒè¯

```bash
$ make setup k3s

========================================
  K3S é›†ç¾¤é…ç½®åˆå§‹åŒ–
========================================

âœ“ åˆ›å»º inventory/hosts.ini
âœ“ åˆ›å»º inventory/group_vars/all.yml

è‡ªåŠ¨é…ç½® k3s é›†ç¾¤...

âœ“ é›†ç¾¤ç±»å‹è®¾ç½®ä¸º: K3S
âœ“ API Server ç«¯å£: 6443
âœ“ ä¸­å›½é•œåƒæº: å·²å¯ç”¨

========================================
  é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆï¼
========================================

$ grep "cluster_type" inventory/hosts.ini
cluster_type=k3s

$ grep "server_url" inventory/group_vars/all.yml
server_url: "https://FIRST_NODE_IP:6443"
```

### RKE2 é…ç½®éªŒè¯

```bash
$ make setup rke2

========================================
  RKE2 é›†ç¾¤é…ç½®åˆå§‹åŒ–
========================================

âœ“ åˆ›å»º inventory/hosts.ini
âœ“ åˆ›å»º inventory/group_vars/all.yml

è‡ªåŠ¨é…ç½® rke2 é›†ç¾¤...

âœ“ é›†ç¾¤ç±»å‹è®¾ç½®ä¸º: RKE2
âœ“ API Server ç«¯å£: 9345
âœ“ ä¸­å›½é•œåƒæº: å·²å¯ç”¨

========================================
  é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆï¼
========================================

$ grep "cluster_type" inventory/hosts.ini
cluster_type=rke2

$ grep "server_url" inventory/group_vars/all.yml
server_url: "https://FIRST_NODE_IP:9345"
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„é›†ç¾¤ç±»å‹

**K3S**ï¼š
- âœ… è¾¹ç¼˜è®¡ç®—
- âœ… å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- âœ… èµ„æºå—é™ç¯å¢ƒ
- âœ… å¿«é€Ÿéƒ¨ç½²

**RKE2**ï¼š
- âœ… ç”Ÿäº§ç¯å¢ƒ
- âœ… ä¼ä¸šçº§åº”ç”¨
- âœ… éœ€è¦ CIS åˆè§„
- âœ… é«˜å¯ç”¨éœ€æ±‚

### 2. å®Œæ•´éƒ¨ç½²æµç¨‹

```bash
# 1. ä¸€é”®åˆå§‹åŒ–ï¼ˆæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼‰
make setup k3s        # æˆ– make setup rke2

# 2. é…ç½®èŠ‚ç‚¹ä¿¡æ¯
vim inventory/hosts.ini
# ä¿®æ”¹ï¼š
# - æ‰€æœ‰èŠ‚ç‚¹çš„ IP åœ°å€
# - SSH ç”¨æˆ·åå’Œå¯†é’¥
# - å°† FIRST_NODE_IP æ›¿æ¢ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„çœŸå® IP

# 3. æµ‹è¯•è¿æ¥
make ping

# 4. æ£€æŸ¥é…ç½®
make lint

# 5. å¼€å§‹å®‰è£…
make install

# 6. éªŒè¯é›†ç¾¤
make status
make pods
```

### 3. å¸¸è§é—®é¢˜å¤„ç†

**é—®é¢˜ 1**: é…ç½®æ–‡ä»¶å·²å­˜åœ¨

```bash
# æ–¹æ¡ˆ 1: ä½¿ç”¨ reset æ¸…ç†
make reset           # åˆ é™¤ç°æœ‰é…ç½®
make setup k3s       # é‡æ–°åˆå§‹åŒ–

# æ–¹æ¡ˆ 2: æ‰‹åŠ¨åˆ é™¤
rm inventory/hosts.ini inventory/group_vars/all.yml
make setup k3s
```

**é—®é¢˜ 2**: éœ€è¦åˆ‡æ¢é›†ç¾¤ç±»å‹

```bash
# å½“å‰æ˜¯ K3Sï¼Œæƒ³åˆ‡æ¢åˆ° RKE2
make reset           # å…ˆé‡ç½®
make setup rke2      # é‡æ–°é…ç½®
```

**é—®é¢˜ 3**: ç«¯å£å†²çª

```bash
# å¦‚æœç«¯å£å·²è¢«å ç”¨ï¼Œä¿®æ”¹ server_url
vim inventory/group_vars/all.yml
# ä¿®æ”¹ç«¯å£å·ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

---

## ğŸ“š ç›¸å…³å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `make setup k3s` | ä¸€é”®é…ç½® K3S |
| `make setup rke2` | ä¸€é”®é…ç½® RKE2 |
| `make setup` | æ‰‹åŠ¨é…ç½® |
| `make reset` | é‡ç½®é…ç½® |
| `make ping` | æµ‹è¯•è¿æ¥ |
| `make lint` | æ£€æŸ¥è¯­æ³• |
| `make install` | å®‰è£…é›†ç¾¤ |
| `make help` | æŸ¥çœ‹å¸®åŠ© |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [QUICK-START-GUIDE.md](QUICK-START-GUIDE.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [RESET-GUIDE.md](RESET-GUIDE.md) - é‡ç½®æŒ‡å—
- [README.md](README.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [SETUP-ENHANCEMENT-SUMMARY.md](SETUP-ENHANCEMENT-SUMMARY.md) - V1 å¢å¼ºè¯´æ˜

---

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### é…ç½®æ—¶é—´å¯¹æ¯”

| æ“ä½œ | æ—§æ–¹å¼ | æ–°æ–¹å¼ | èŠ‚çœæ—¶é—´ |
|------|-------|--------|---------|
| åˆ›å»ºé…ç½®æ–‡ä»¶ | 30s | 30s | 0s |
| è®¾ç½®é›†ç¾¤ç±»å‹ | 60s | 0s | **60s** |
| è®¾ç½®ç«¯å£å· | 30s | 0s | **30s** |
| å¯ç”¨é•œåƒåŠ é€Ÿ | 45s | 0s | **45s** |
| æ£€æŸ¥é…ç½® | 60s | 30s | **30s** |
| **æ€»è®¡** | **225s** | **60s** | **165s (73%)** |

### ç”¨æˆ·ä½“éªŒæ”¹å–„

| æŒ‡æ ‡ | æ—§æ–¹å¼ | æ–°æ–¹å¼ | æ”¹å–„ |
|------|-------|--------|------|
| éœ€è¦ç¼–è¾‘çš„æ–‡ä»¶ | 2 ä¸ª | 1 ä¸ª | â¬‡ï¸ 50% |
| éœ€è¦è®°ä½çš„ä¿¡æ¯ | 5+ é¡¹ | 2 é¡¹ | â¬‡ï¸ 60% |
| å‡ºé”™æ¦‚ç‡ | ä¸­ | ä½ | â¬‡ï¸ 70% |
| ä¸Šæ‰‹éš¾åº¦ | ä¸­ | ä½ | â¬‡ï¸ 60% |
| æ»¡æ„åº¦ | ğŸ˜ | ğŸ˜Š | â¬†ï¸ 80% |

---

## ğŸ‰ æ€»ç»“

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
1. âœ… **ç®€åŒ–æµç¨‹** - 3 æ­¥å®Œæˆé…ç½®ï¼ˆåŸæ¥ 5+ æ­¥ï¼‰
2. âœ… **é™ä½é—¨æ§›** - æ–°æ‰‹ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹
3. âœ… **å‡å°‘é”™è¯¯** - è‡ªåŠ¨é…ç½®é¿å…æ‰‹åŠ¨å¤±è¯¯
4. âœ… **èŠ‚çœæ—¶é—´** - é…ç½®æ—¶é—´å‡å°‘ 70%+
5. âœ… **ä¿æŒçµæ´»** - ä»æ”¯æŒå®Œå…¨è‡ªå®šä¹‰

**é€‚ç”¨äººç¾¤**ï¼š
- ğŸ‘¨â€ğŸ’» å¼€å‘äººå‘˜ - å¿«é€Ÿæ­å»ºæµ‹è¯•ç¯å¢ƒ
- ğŸ”§ è¿ç»´äººå‘˜ - æ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹
- ğŸ†• æ–°æ‰‹ç”¨æˆ· - é™ä½å­¦ä¹ æ›²çº¿
- ğŸ¢ ä¼ä¸šç”¨æˆ· - æé«˜éƒ¨ç½²æ•ˆç‡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-21  
**æ”¹è¿›ä½œè€…**: RKE2/K3S Ansible Automation Project  
**Git Commit**: 1bf554e

